---

title: Solution ‚Äì Build and Run Your First Image
sidebar_position: 58
---------------------

## ‚úÖ Solution: Fixing and Optimizing the Broken Dockerfile

In this challenge, you were given a broken Dockerfile and asked to:

* Build the image,
* Run the container,
* Fix runtime issues (missing files, env var),
* Optimize the Dockerfile using a multi-stage build.

---

## üß± Original Broken Dockerfile (Before Fix)

```Dockerfile
FROM golang:1.18

WORKDIR /app

RUN go build -o test-app

ENTRYPOINT ["/app/test-app"]
```

### ‚ùå Problems with this:

| Issue              | Explanation                                                                                 |
| ------------------ | ------------------------------------------------------------------------------------------- |
| No `COPY` command  | The Go source files (`main.go`, etc.) are never copied into the image, so `go build` fails. |
| No `ENV` var       | The app expects an environment variable `APP_USER`, but it‚Äôs not set in the image.          |
| Single-stage build | Final image contains Go compiler and all its dependencies (\~967MB).                        |

---

## üõ†Ô∏è Step-by-Step Fixes

### ‚úÖ 1. Add `COPY . /app` **before** the `RUN` command

Why? Docker builds layers top-down. If you copy files **after** `RUN`, the build
step won‚Äôt have access to your Go code.

```Dockerfile
COPY . /app
```

---

### ‚úÖ 2. Add a default environment variable

The app expects `APP_USER` to be present. Set it during build with:

```Dockerfile
ENV APP_USER=whatever
```

---

## üß™ Final Fixed Dockerfile (Single-stage)

```Dockerfile
FROM golang:1.18

WORKDIR /app

COPY . /app

ENV APP_USER=whatever

RUN go build -o test-app

ENTRYPOINT ["/app/test-app"]
```

---

### üîÑ Build & Run

```bash
# Build
docker build -t test-app .

# Run
docker run --rm test-app
```

‚úÖ Output:

```
Hello, whatever
```

---

### üîÅ Change app user at runtime

```bash
docker run --rm -e APP_USER=carlos test-app
```

‚úÖ Output:

```
Hello, carlos
```

---

## üåü Extra Credit: Multi-Stage Minimal Dockerfile

> Create a **2MB** image using `FROM scratch` and multi-stage build.

---

### üß± Multi-Stage Dockerfile (Final Optimized)

```Dockerfile
# Stage 1 ‚Äì Build Go app
FROM golang:1.18 AS base

WORKDIR /app

COPY . /app

ENV APP_USER=whatever

RUN go build -o test-app

# Stage 2 ‚Äì Final minimal image
FROM scratch AS app

COPY --from=base /app/test-app /test-app

ENV APP_USER=whatever

ENTRYPOINT ["/test-app"]
```

---

### üõ†Ô∏è Build & Run Optimized Image

```bash
# Build
docker build -t test-app2 .

# Run
docker run --rm test-app2
```

‚úÖ Output:

```
Hello, whatever
```

---

## üîç Compare Image Sizes

```bash
docker images "test-app*"
```

| Image Name                | Size     |
| ------------------------- | -------- |
| `test-app` (single-stage) | \~967 MB |
| `test-app2` (scratch)     | \~2 MB   |

> ‚ö° The optimized image is \~**480x smaller**!

---

## ‚ùìWhy Is `FROM scratch` So Effective?

| Advantage | Reason                                   |
| --------- | ---------------------------------------- |
| Smaller   | No OS, no Go compiler, no shell          |
| Secure    | Only your binary = fewer vulnerabilities |
| Faster    | Pulls in seconds, great for CI/CD        |

---

## üß† Q\&A

### Q1: Why did we get an error about `go.mod`?

**Answer**: Because `go build` couldn‚Äôt find source files‚Äîit never received them
without `COPY`.

---

### Q2: Why does COPY need to come before RUN?

**Answer**: Each Dockerfile command creates a layer. If you run a command that
depends on files **before** copying them, the command fails.

---

### Q3: What if I want to override `APP_USER` at runtime?

**Answer**: Use the `-e` flag:

```bash
docker run -e APP_USER=sumanth test-app2
```

---

## üßæ Summary

| Task                                      | Status |
| ----------------------------------------- | ------ |
| Fix Dockerfile structure                  | ‚úÖ     |
| Add `COPY`, `ENV`, proper `RUN` ordering  | ‚úÖ     |
| Build & run image with default `APP_USER` | ‚úÖ     |
| Add runtime override for `APP_USER`       | ‚úÖ     |
| Use multi-stage + scratch to optimize     | ‚úÖ     |
| Compare sizes & security improvements     | ‚úÖ     |

---

**Congratulations**! You now know how to:

- Debug Dockerfile issues,
- Use environment variables,
- Use multi-stage builds,
- Create tiny & secure containers.

---
