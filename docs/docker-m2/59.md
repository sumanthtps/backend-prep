---
id: docker-authenticated-registries
title: Authenticated Docker Registries
sidebar_label: Authenticated Registries
sidebar_position: 84
---

## Summary

While local Docker registries are useful, they lack authentication and
encryption. In real-world scenarios, especially in corporate environments, it is
essential to secure your registry using HTTPS and password-based authentication.
This can be done by placing a **reverse proxy (like NGINX)** in front of the
registry.

---

## Key Concepts

### Why Not Use the Default Local Registry?

- **No HTTPS**: Traffic (including sensitive images) is transmitted in plain
  text
- **No authentication**: Anyone can push/pull images
- **Not production ready**: No customizability, no network-layer controls

---

## Setup: Secured Registry with NGINX Proxy

### Step 1: Create a Docker bridge network

```bash
docker network create registry
```

This allows Docker containers (registry + nginx) to talk to each other using DNS
(`registry-backend` hostname).

---

### Step 2: Create SSL certs using OpenSSL

Use a script like `create-unsigned-certs.sh` that runs OpenSSL in a container
and generates:

```
certs/
  ‚îú‚îÄ‚îÄ cert.pem
  ‚îî‚îÄ‚îÄ key.pem
```

---

### Step 3: Add cert to your local machine as trusted CA

SSH into the Docker VM (e.g., Lima or Docker Desktop Linux VM):

```bash
limactl shell docker
```

Copy the cert:

```bash
sudo cp certs/cert.pem /usr/local/share/ca-certificates/registry.crt
sudo update-ca-certificates
```

Make sure the output says `1 added`.

---

### Step 4: Set up authentication using `htpasswd`

Use the `httpd:2` image to generate a hashed credentials file:

```bash
docker run --entrypoint htpasswd httpd:2 -Bbn admin supersecret > htpasswd
```

This creates:

```
htpasswd
```

Containing: `admin:<bcrypt-hash>`

---

### Step 5: Run the actual registry (backend only)

```bash
docker run --rm -d \
  --name registry-backend \
  --network registry \
  registry:2
```

Note: No need to publish port; it's internal-only.

---

### Step 6: Create the NGINX reverse proxy container

Use a custom `nginx.conf` that:

- Proxies requests to `registry-backend:5000`
- Uses `/certs/cert.pem` and `/certs/key.pem`
- Enforces basic auth using `/auth/htpasswd`

Then run:

```bash
docker run --rm -d \
  -p 5000:5000 \
  --name registry-proxy \
  --network registry \
  -v ./nginx.conf:/etc/nginx/nginx.conf \
  -v ./htpasswd:/auth/htpasswd \
  -v ./certs:/certs \
  nginx
```

---

### Step 7: Login and Push

```bash
docker login https://localhost:5000
# Username: admin
# Password: supersecret
```

Push tagged image:

```bash
docker tag my-image localhost:5000/my-image
docker push localhost:5000/my-image
```

Pull from secure registry:

```bash
docker run --rm localhost:5000/my-image
```

‚úÖ You now have a TLS-encrypted, authenticated private registry.

---

## INFO PANEL

> **Note:** Docker CLI cannot push **multi-arch manifest lists** to local secure
> registries due to a known bug. It works fine with remote registries like
> GitHub Container Registry or AWS ECR.

---

## Popular Alternative Registries

### üîê Why Use Alternatives to Docker Hub?

1. **Security & Privacy**: Protect internal images (sensitive data, config)
2. **Pull Limits**: Docker Hub has strict rate limits (e.g., 100 pulls per 6
   hrs)
3. **Offline/On-prem Use**: Some orgs disable external access entirely

---

## Types of Container Registries

### 1. Source-Code Hosting Registries

Examples:

- GitHub Container Registry (`ghcr.io`)
- GitLab Container Registry

‚úÖ Easy to use ‚úÖ Free for public repos ‚ö†Ô∏è Requires project to exist on the
platform ‚ö†Ô∏è Limited UI controls

---

### 2. Cloud Provider Registries

Examples:

- **AWS ECR**
- **Azure Container Registry**
- **Google Artifact Registry**

‚úÖ Strong integration with CI/CD and cloud services ‚úÖ Scalable, API-driven ‚ö†Ô∏è
Requires account, credit card, and billing setup ‚ö†Ô∏è Slightly complex login
process via token or CLI

---

### 3. Enterprise Registries

Examples:

- **Harbor (VMware)**
- **JFrog Artifactory**
- **Quay (Red Hat)**

‚úÖ Full enterprise control: on-premise + cloud ‚úÖ Advanced features (scanning,
RBAC, compliance) ‚ö†Ô∏è Paid offerings (sometimes expensive) ‚ö†Ô∏è More complex to
deploy and maintain

---

## Questions & Answers

**Q1: Why not push directly to a self-hosted registry on HTTP?** **A1:** It's
insecure. Credentials and image layers can be intercepted.

**Q2: What is the role of a reverse proxy in secure registries?** **A2:** It
handles HTTPS termination and authentication before forwarding requests to the
internal registry.

**Q3: What does the `htpasswd` tool do?** **A3:** It creates a password file
with bcrypt-hashed entries for basic HTTP authentication.

**Q4: Why is `update-ca-certificates` needed?** **A4:** So your Docker CLI
trusts the self-signed cert and doesn't block HTTPS connections to the registry.

**Q5: What is the limitation with pushing manifest lists to secure local
registries?** **A5:** The Docker CLI can't fetch digests from local HTTPS
registries due to a known bug in insecure cert handling. Remote registries work
fine.
