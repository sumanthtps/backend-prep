---
id: container-limits-part-2
title: Setting Container Limits Part 2
sidebar_label: Container Limits Part 2
sidebar_position: 62
---

## Summary

This section builds upon the previous lesson on Docker CPU and memory limits.
The instructor performs **live experiments** using the
[`stress`](https://linux.die.net/man/1/stress) tool to demonstrate how CPU and
memory flags (`--cpus`, `--cpu-quota`, `--cpu-period`, `--memory`) behave under
load. Using `top -d 0.1`, we visualize how Docker constraints interact with
Linux **CPU schedulers** and **control groups (cgroups)** in real time.

---

## Key Concepts with Examples

### üß™ Experiment Setup

- Left terminal: `top -d 0.1` (samples system usage every 100ms)
- Right terminal: runs Docker `stress` containers

---

## üß† CPU Constraint Demonstration

### Full CPU Load

```bash
docker run --rm stress --cpu 4 --timeout 5
```
````

- Utilizes 4 CPU workers (1 per logical core)
- CPU usage \~100% on each core

---

### Limit to 40% CPU (`--cpus`)

```bash
docker run --rm --cpus=1.6 stress --cpu 4 --timeout 5
```

- On a 4-core machine, `1.6` means 40% of available compute
- Scheduler tries to honor this percentage on average

---

### Equivalent via `--cpu-quota` and `--cpu-period`

```bash
docker run --rm \
  --cpu-period=100000 \
  --cpu-quota=160000 \
  stress --cpu 4 --timeout 5
```

- `160000 / 100000 = 1.6 CPUs`, same as above

---

### Alternative View: Increase Frequency Instead

```bash
docker run --rm \
  --cpu-period=60000 \
  --cpu-quota=100000 \
  stress --cpu 4 --timeout 5
```

- Scheduler hits container more frequently (every 60ms)
- Still results in \~40% utilization

---

## üíæ Memory Constraint Demonstration

### Memory Flooding

```bash
docker run --rm stress --vm 1 --vm-bytes 3.99G --timeout 5
```

- Attempts to allocate nearly all memory on the machine
- Causes visible **system memory drop**
- May trigger **OOM killer**

> üß† Top command on Linux shows memory in different ways:
>
> - Some show total directly
> - Others show free + used (you add them)

---

### Limit to 2GB Memory

```bash
docker run --rm --memory=2G \
  stress --vm 1 --vm-bytes 3.99G --timeout 5
```

- Container exceeds limit, gets `SIGKILL (9)` from kernel
- Observed as immediate container crash after \~2GB

---

## ‚ö†Ô∏è OOM Killer Behavior

### Can we disable it?

```bash
docker run --rm --memory=2G --oom-kill-disable \
  stress --vm 1 --vm-bytes 3.99G --timeout 5
```

- ‚ùå Doesn‚Äôt work on all kernels
- If supported, container hangs instead of dying
- ‚ö†Ô∏è Not recommended: leads to zombie containers

---

## üîç Visualizing Resource Usage

### Sample `top -d 0.1` Output Snapshot

![Top output example](https://upload.wikimedia.org/wikipedia/commons/f/f5/Top_command.png)

> üì∑ Source:
> [Wikipedia - top (Unix)](https://en.wikipedia.org/wiki/Top_%28software%29)

---

## üßµ Summary Table

| Flag                 | Description                                    | Example               |
| -------------------- | ---------------------------------------------- | --------------------- |
| `--cpus`             | Fractional CPU limit                           | `--cpus=1.6`          |
| `--cpu-quota`        | Max ¬µs container can run per period            | `--cpu-quota=160000`  |
| `--cpu-period`       | Time window in ¬µs (default: 100000)            | `--cpu-period=100000` |
| `--memory`           | Memory hard limit                              | `--memory=2G`         |
| `--oom-kill-disable` | Disable killing on OOM (kernel support needed) | `--oom-kill-disable`  |

---

## ‚úÖ Best Practices

- Always set **`--memory`** in production workloads
- Use `--cpus` for **simple limits**, and `--cpu-*` for **precise control**
- Let kernel handle **OOM kills**; avoid disabling it
- Use monitoring tools (`top`, `docker stats`, Prometheus) to observe behavior

---

## ‚ùìQuestions for Review

1. Why might `--cpus=1.6` and `--cpu-quota=160000` behave identically?
2. What are the risks of using `--oom-kill-disable` in production?
3. How does memory allocation differ from CPU in terms of behavior and kill
   signals?
4. Why does Docker not allow allocating more memory than physically available?

---

```

```
