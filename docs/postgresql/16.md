---
sidebar_position: 16
---
# PostgreSQL Replication & High Availability
Replication ensures **data availability, fault tolerance, and scalability** by keeping copies of the database synchronized. High Availability (HA) strategies minimize **downtime and data loss** in case of failures.  

---

## **1Ô∏è‚É£ Types of Replication in PostgreSQL**
| Replication Type | Description | Use Case |
|------------------|-------------|----------|
| **Streaming Replication** | Real-time copy of the primary database to standby servers | High Availability (Failover) |
| **Logical Replication** | Selectively replicates specific tables | Multi-region databases, analytics |
| **WAL Archiving** | Saves Write-Ahead Logs (WAL) for backup & disaster recovery | Point-in-time recovery |
| **Synchronous Replication** | Ensures committed data is written to standby before confirming commit | Zero data loss requirement |
| **Asynchronous Replication** | Allows minor data lag between primary and standby | Faster performance |

---

## **2Ô∏è‚É£ Streaming Replication (Physical Replication)**
‚úî **Creates an exact copy of the primary database**.  
‚úî Standby servers **continuously apply WAL logs** from the primary.  
‚úî Supports **failover** (promote standby to primary if primary fails).  

‚úÖ **Step 1: Enable Replication on Primary**  
Edit `postgresql.conf`:  
```conf
wal_level = replica
max_wal_senders = 5
hot_standby = on
```

‚úÖ **Step 2: Allow Standby Connections (`pg_hba.conf`)**  
```conf
host replication replica_user 192.168.1.100/24 md5
```

‚úÖ **Step 3: Start Standby Server**  
Run `pg_basebackup`:  
```sh
pg_basebackup -h primary_host -U replica_user -D /var/lib/postgresql/data -P -R
```
üöÄ **Now, standby automatically syncs with the primary!**  

---

## **3Ô∏è‚É£ Logical Replication (Table-Level Replication)**
‚úî Unlike streaming replication, **logical replication allows selective replication of tables instead of the full database**.  
‚úî Used for **cross-version replication, multi-region databases, analytics, and migrations**.  

‚úÖ **Step 1: Enable Logical Replication on Primary**  
Edit `postgresql.conf`:  
```conf
wal_level = logical
max_replication_slots = 5
```

‚úÖ **Step 2: Create a Publication on Primary**  
```sql
CREATE PUBLICATION my_pub FOR TABLE users, orders;
```
üöÄ **Now, `users` and `orders` tables are available for replication.**  

‚úÖ **Step 3: Create a Subscription on Standby**  
```sql
CREATE SUBSCRIPTION my_sub CONNECTION 'host=primary_host dbname=mydb user=replica_user' 
PUBLICATION my_pub;
```
üöÄ **Only selected tables are replicated!**  

---

## **4Ô∏è‚É£ WAL Archiving (Point-in-Time Recovery)**
‚úî **Stores Write-Ahead Logs (WAL) for disaster recovery.**  
‚úî Allows **restoring the database to any point in time**.  

‚úÖ **Enable WAL Archiving (`postgresql.conf`)**  
```conf
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/wal_archive/%f'
```
üöÄ **Archived WAL logs can be used to restore data!**  

‚úÖ **Perform a Point-in-Time Recovery (PITR)**  
```sh
pg_restore -h primary_host -U postgres -d mydb -W --no-owner my_backup.sql
```
‚úî **Restores the database from WAL logs.**  

---

## **5Ô∏è‚É£ Failover & High Availability**
Failover **promotes a standby server to primary** if the main server crashes.  

‚úî **Automated Failover with `pg_ctl promote` (Manual Promotion)**  
```sh
pg_ctl -D /var/lib/postgresql/data promote
```
‚úî **Automated Failover Tools:**  
- **Patroni** (Highly recommended for HA setups)  
- **Repmgr** (Monitors and manages failover)  
- **Pgpool-II** (Load balancing & failover)  

---

## **6Ô∏è‚É£ Clustering & Load Balancing**
‚úî **Pgpool-II** balances read queries across replicas.  
‚úî **Barman** automates backups for multiple PostgreSQL servers.  
‚úî **Citus** allows horizontal scaling by distributing queries across nodes.  

---

## **üìù Quiz - Replication & High Availability**
1Ô∏è‚É£ What is the difference between **Streaming Replication** and **Logical Replication**?  
2Ô∏è‚É£ What does `pg_basebackup` do?  
3Ô∏è‚É£ How can you enable **WAL Archiving** in PostgreSQL?  
4Ô∏è‚É£ Which tool is commonly used for **automated failover**?  
5Ô∏è‚É£ What command promotes a **standby server** to primary?  

Great! Here are the answers:  

1Ô∏è‚É£ **What is the difference between Streaming Replication and Logical Replication?**  
‚úî **Streaming Replication:**  
   - Copies the **entire database** to a standby server.  
   - Works at the **WAL (Write-Ahead Log) level** (binary replication).  
   - Best for **failover and disaster recovery**.  

‚úî **Logical Replication:**  
   - **Replicates specific tables** instead of the whole database.  
   - Works at the **SQL statement level** (table-based replication).  
   - Best for **multi-region setups, migrations, and analytics**.  

‚úÖ **Example Command for Logical Replication:**  
```sql
CREATE PUBLICATION my_pub FOR TABLE users;
```

---

2Ô∏è‚É£ **What does `pg_basebackup` do?**  
‚úî `pg_basebackup` **creates a full backup of the primary database** for setting up a standby server.  
‚úî It copies **data and WAL logs** to initialize replication.  

‚úÖ **Example Command:**  
```sh
pg_basebackup -h primary_host -U replica_user -D /var/lib/postgresql/data -P -R
```
üöÄ **After running this, the standby will start replicating!**  

---

3Ô∏è‚É£ **How can you enable WAL Archiving in PostgreSQL?**  
‚úî Enable **WAL Archiving** in `postgresql.conf`:  
```conf
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/wal_archive/%f'
```
‚úî Stores **WAL logs for point-in-time recovery (PITR)**.  

‚úÖ **To restore data from WAL logs:**  
```sh
pg_restore -h primary_host -U postgres -d mydb -W --no-owner my_backup.sql
```

---

4Ô∏è‚É£ **Which tool is commonly used for automated failover?**  
‚úî **Patroni** is the most popular tool for **automated failover** in PostgreSQL.  
‚úî **Other options:** `Repmgr`, `Pgpool-II`, `Barman`.  

‚úÖ **Example Patroni command:**  
```sh
patronictl failover my_cluster --candidate standby1
```

---

5Ô∏è‚É£ **What command promotes a standby server to primary?**  
‚úî Use `pg_ctl promote` to manually promote a standby to primary:  
```sh
pg_ctl -D /var/lib/postgresql/data promote
```
üöÄ **The standby immediately becomes the new primary!**  

üî• **Score: 5/5 if you got all correct!** üéØ  

---

### **Next Topic: PostgreSQL Extensions & Advanced Tools** üöÄ  
We‚Äôll cover **PostGIS (GIS), TimescaleDB (Time-Series), pg_partman (Partitioning), and pg_stat_statements (Query Monitoring)**. Ready? (y/n)