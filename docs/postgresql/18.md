---
sidebar_position: 18
---
# PostgreSQL Backup & Disaster Recovery 
Backing up and restoring data is **critical for preventing data loss**. PostgreSQL provides **full backups, point-in-time recovery, and high-availability solutions** to ensure disaster recovery.  

---

## **1Ô∏è‚É£ Backup Methods in PostgreSQL**
| Backup Type | Description | Best For |
|------------|-------------|----------|
| **Logical Backup (`pg_dump`)** | Exports schema & data into a SQL file | Small databases, selective backups |
| **Physical Backup (`pg_basebackup`)** | Copies entire database cluster | Replication & full database recovery |
| **WAL Archiving (Point-in-Time Recovery - PITR)** | Saves transaction logs for incremental restore | Disaster recovery, rollback to any point in time |
| **Backup Tools (`barman`, `pgBackRest`)** | Automates backups & restores | Large-scale production databases |

---

## **2Ô∏è‚É£ Logical Backup with `pg_dump`**
‚úî **Creates a portable SQL file** that can be restored on any PostgreSQL instance.  

‚úÖ **Backing Up a Single Database**  
```sh
pg_dump -U postgres -d mydb -F c -f mydb_backup.dump
```
- `-F c` ‚Üí Custom format (best for large databases).  
- `-f` ‚Üí Output file name.  

‚úÖ **Backing Up a Specific Table**  
```sh
pg_dump -U postgres -d mydb -t users -F c -f users_backup.dump
```

‚úÖ **Backing Up Only Schema (No Data)**  
```sh
pg_dump -U postgres -d mydb -s -f schema_only.sql
```

üöÄ **Restoring a Backup with `pg_restore`**  
```sh
pg_restore -U postgres -d mydb mydb_backup.dump
```

‚úî **Use `-C` to create the database before restoring:**  
```sh
pg_restore -U postgres -C -d postgres mydb_backup.dump
```

---

## **3Ô∏è‚É£ Physical Backup with `pg_basebackup`**
‚úî **Copies the entire PostgreSQL data directory** (needed for replication).  

‚úÖ **Creating a Full Physical Backup**  
```sh
pg_basebackup -U postgres -D /backup/postgresql/ -Ft -z -P
```
- `-Ft` ‚Üí Tar format  
- `-z` ‚Üí Compress backup  
- `-P` ‚Üí Show progress  

‚úÖ **Restoring a Physical Backup**  
```sh
tar -xzf /backup/postgresql/base.tar.gz -C /var/lib/postgresql/data/
```
üöÄ **Restart PostgreSQL after restore:**  
```sh
systemctl restart postgresql
```

---

## **4Ô∏è‚É£ Point-in-Time Recovery (PITR)**
‚úî **Restores the database to any point in time** using WAL logs.  
‚úî Requires **WAL Archiving to be enabled**.  

‚úÖ **Step 1: Enable WAL Archiving** (`postgresql.conf`)  
```conf
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/wal_archive/%f'
```

‚úÖ **Step 2: Backup the Base Data Directory**  
```sh
pg_basebackup -U postgres -D /backup/full_backup/
```

‚úÖ **Step 3: Restore from WAL Logs**  
Modify `recovery.conf`:  
```conf
restore_command = 'cp /var/lib/postgresql/wal_archive/%f %p'
recovery_target_time = '2025-03-01 10:30:00'
```
üöÄ **Restart PostgreSQL to apply recovery:**  
```sh
systemctl restart postgresql
```
‚úî **Now, the database is restored to the exact time!**  

---

## **5Ô∏è‚É£ Automated Backups with `pgBackRest`**
‚úî **Better than `pg_dump` & `pg_basebackup`** for large databases.  
‚úî Supports **incremental backups** to save storage.  

‚úÖ **Install & Initialize `pgBackRest`**  
```sh
apt install pgbackrest
pgbackrest --stanza=main stanza-create
```

‚úÖ **Create a Backup**  
```sh
pgbackrest --stanza=main --type=full backup
```

‚úÖ **Restore a Backup**  
```sh
pgbackrest --stanza=main restore
```

---

## **üìù Quiz - PostgreSQL Backup & Recovery**
1Ô∏è‚É£ What is the difference between **pg_dump** and **pg_basebackup**?  
2Ô∏è‚É£ How do you backup only the schema (without data) using `pg_dump`?  
3Ô∏è‚É£ What is the purpose of **Point-in-Time Recovery (PITR)**?  
4Ô∏è‚É£ How do you enable **WAL archiving** for PITR?  
5Ô∏è‚É£ Which tool provides **incremental backups** for PostgreSQL?  

Here are the correct answers:  

1Ô∏è‚É£ **What is the difference between `pg_dump` and `pg_basebackup`?**  
‚úî `pg_dump`:  
   - **Logical backup** (exports schema & data as SQL).  
   - **Restores to any PostgreSQL instance**.  
   - Best for **small databases & migrations**.  
   ```sh
   pg_dump -U postgres -d mydb -F c -f mydb_backup.dump
   ```

‚úî `pg_basebackup`:  
   - **Physical backup** (copies the entire data directory).  
   - Only works for **replica/failover setups**.  
   ```sh
   pg_basebackup -U postgres -D /backup/postgresql/ -Ft -z -P
   ```

---

2Ô∏è‚É£ **How do you backup only the schema (without data) using `pg_dump`?**  
‚úÖ Use the `-s` (schema-only) flag:  
```sh
pg_dump -U postgres -d mydb -s -f schema_only.sql
```
‚úî **Exports table structures but not the data**.  

---

3Ô∏è‚É£ **What is the purpose of Point-in-Time Recovery (PITR)?**  
‚úî **Restores the database to an exact point in time using WAL logs.**  
‚úî Useful for **disaster recovery** or **undoing accidental changes**.  

‚úÖ **Example PITR Recovery (`recovery.conf`)**:  
```conf
restore_command = 'cp /var/lib/postgresql/wal_archive/%f %p'
recovery_target_time = '2025-03-01 10:30:00'
```
üöÄ Restores the database to **March 1, 2025, at 10:30 AM**.  

---

4Ô∏è‚É£ **How do you enable WAL archiving for PITR?**  
‚úÖ Modify `postgresql.conf`:  
```conf
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/wal_archive/%f'
```
‚úî **Stores WAL logs** for future recovery.  

---

5Ô∏è‚É£ **Which tool provides incremental backups for PostgreSQL?**  
‚úî **pgBackRest** supports **incremental backups**, saving only **changed data** to reduce storage usage.  

‚úÖ **Example pgBackRest backup command:**  
```sh
pgbackrest --stanza=main --type=full backup
```
üöÄ **More efficient than `pg_dump` & `pg_basebackup`!**  

üî• **Score: 5/5 if you got all correct!** üéØ  

---

### **Next Topic: Advanced Query Optimization Techniques** üöÄ  
We‚Äôll cover **Index-Only Scans, Bitmap Index Scans, Query Execution Plans (`EXPLAIN ANALYZE` Deep Dive), and Optimizer Hints**. Ready? (y/n)