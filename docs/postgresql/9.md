---
sidebar_position: 9
---
# Stored Procedures & Functions
PostgreSQL supports **functions** and **stored procedures** using **PL/pgSQL** (Procedural Language/PostgreSQL). These allow you to write reusable logic inside the database.  

---

## **1Ô∏è‚É£ Difference Between Functions & Procedures**
| Feature         | Function (`CREATE FUNCTION`) | Procedure (`CREATE PROCEDURE`) |
|---------------|-----------------|-----------------|
| **Returns Value?** | ‚úÖ Yes (`RETURNS data_type`) | ‚ùå No (`CALL procedure_name`) |
| **Can Be Used in Queries?** | ‚úÖ Yes | ‚ùå No |
| **Supports Transactions (`COMMIT/ROLLBACK`)?** | ‚ùå No | ‚úÖ Yes |
| **Best For** | Computations & returning values | Multi-step operations (e.g., batch updates) |

---

## **2Ô∏è‚É£ Creating a Function (`CREATE FUNCTION`)**
Functions **return values** and are commonly used in queries.  

‚úÖ **Example:** Function to calculate total order amount for a user:  
```sql
CREATE FUNCTION get_total_orders(user_id INT) 
RETURNS NUMERIC AS $$
DECLARE total NUMERIC;
BEGIN
    SELECT SUM(amount) INTO total FROM orders WHERE orders.user_id = get_total_orders.user_id;
    RETURN total;
END;
$$ LANGUAGE plpgsql;
```
üöÄ **Usage:**  
```sql
SELECT get_total_orders(1);
```
‚úÖ **Benefits of Functions:**  
‚úî Can be used in `SELECT` statements.  
‚úî Optimized and cached for performance.  

---

## **3Ô∏è‚É£ Creating a Stored Procedure (`CREATE PROCEDURE`)**
Procedures **do not return values** but allow **transactions inside them**.  

‚úÖ **Example:** Procedure to transfer money between accounts:  
```sql
CREATE PROCEDURE transfer_money(sender INT, receiver INT, amount NUMERIC) 
LANGUAGE plpgsql AS $$
BEGIN
    BEGIN TRANSACTION;
    UPDATE accounts SET balance = balance - amount WHERE id = sender;
    UPDATE accounts SET balance = balance + amount WHERE id = receiver;
    COMMIT;
END;
$$;
```
üöÄ **Usage:**  
```sql
CALL transfer_money(1, 2, 100);
```
‚úÖ **Benefits of Procedures:**  
‚úî Supports **transactions** (`COMMIT`, `ROLLBACK`).  
‚úî Useful for **batch processing & admin tasks**.  

---

## **4Ô∏è‚É£ VOLATILE vs. STABLE vs. IMMUTABLE Functions**
PostgreSQL allows optimization based on function **volatility**:  

| Type        | Description | Use Case |
|------------|-------------|----------|
| **VOLATILE**  | Function **changes every call** | `RANDOM()`, `NOW()` |
| **STABLE**  | Function returns **same result for the same input** | `EXTRACT(YEAR FROM date)` |
| **IMMUTABLE** | Function **always returns the same output for same input** | `UPPER(text)`, `ROUND(number, decimals)` |

‚úÖ **Example:** Marking a function as `IMMUTABLE`:  
```sql
CREATE FUNCTION get_discount(price NUMERIC) 
RETURNS NUMERIC 
IMMUTABLE AS $$ 
BEGIN RETURN price * 0.9; 
END; 
$$ LANGUAGE plpgsql;
```
üöÄ **This allows PostgreSQL to cache results and optimize queries!**  

---

## **5Ô∏è‚É£ Table Functions (Returning Multiple Rows)**
‚úÖ **Example:** Function to get all orders of a user:  
```sql
CREATE FUNCTION get_user_orders(uid INT) 
RETURNS TABLE(order_id INT, amount NUMERIC) AS $$
BEGIN
    RETURN QUERY SELECT id, amount FROM orders WHERE user_id = uid;
END;
$$ LANGUAGE plpgsql;
```
üöÄ **Usage:**  
```sql
SELECT * FROM get_user_orders(1);
```

---

## **6Ô∏è‚É£ Exception Handling in Functions & Procedures**
‚úÖ **Example:** Handling errors in a stored procedure:  
```sql
CREATE PROCEDURE safe_transfer(sender INT, receiver INT, amount NUMERIC) 
LANGUAGE plpgsql AS $$
BEGIN
    BEGIN TRANSACTION;
    UPDATE accounts SET balance = balance - amount WHERE id = sender;
    UPDATE accounts SET balance = balance + amount WHERE id = receiver;
    COMMIT;
EXCEPTION WHEN others THEN
    ROLLBACK;
    RAISE NOTICE 'Transaction failed!';
END;
$$;
```
üöÄ **This ensures rollback if an error occurs.**  

---

## **üìù Quiz - Stored Procedures & Functions**
1Ô∏è‚É£ What is the key difference between `CREATE FUNCTION` and `CREATE PROCEDURE`?  
2Ô∏è‚É£ Which function volatility type (`VOLATILE`, `STABLE`, `IMMUTABLE`) is best for `NOW()`?  
3Ô∏è‚É£ How do you call a procedure in PostgreSQL?  
4Ô∏è‚É£ Can functions be used in `SELECT` queries?  
5Ô∏è‚É£ How can you handle errors in a stored procedure?  

Drop your answers, and we‚Äôll move to the next advanced topic! üöÄ